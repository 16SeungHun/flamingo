stages:
- test
- build
- build frontend
- publish

test flamingo:
  stage: test
  image: thebod/goenv:0.0.1
  script:
  - export GODIR="${GOPATH}/src/flamingo"
  - ln -sfv "$(pwd -P)" "${GODIR}"
  - /pact/pact-go_linux_amd64 daemon &
  - cd "${GODIR}"
  - dep ensure -vendor-only
  - go test ./...
  cache:
    paths:
    - vendor/

test frontend akl:
  stage: test
  image: aoepeople/fe-build-env:1.3.0
  script:
  - cd akl/frontend
  - yarn install
  - npm rebuild node-sass
  - yarn test
  cache:
    paths:
    - akl/frontend/node_modules/

test frontend lhr:
  image: aoepeople/fe-build-env:1.3.0
  stage: test
  script:
  - cd lhr/frontend
  - yarn install
  - npm rebuild node-sass
  - yarn test
  cache:
    paths:
    - lhr/frontend/node_modules/

build akl:
  stage: build
  image: thebod/goenv:0.0.1
  script:
  - export GODIR="${GOPATH}/src/flamingo"
  - ln -sfv "$(pwd -P)" "${GODIR}"
  - cd "${GODIR}/akl"
  - go build .
  cache:
    paths:
    - vendor/
  artifacts:
    paths:
    - akl/akl
  dependencies:
  - test flamingo
  - test frontend akl

build lhr:
  stage: build
  image: thebod/goenv:0.0.1
  script:
  - export GODIR="${GOPATH}/src/flamingo"
  - ln -sfv "$(pwd -P)" "${GODIR}"
  - cd "${GODIR}/lhr"
  - go build .
  cache:
    paths:
    - vendor/
  artifacts:
    paths:
    - lhr/lhr
  dependencies:
  - test flamingo
  - test frontend akl

build frontend akl:
  stage: build frontend
  image: aoepeople/fe-build-env:1.3.0
  script:
  - cd akl/frontend
  - yarn run build
  cache:
    paths:
    - akl/frontend/node_modules/
    - vendor/
  artifacts:
    paths:
    - akl/frontend/dist

build frontend lhr:
  image: aoepeople/fe-build-env:1.3.0
  stage: build frontend
  script:
  - cd lhr/frontend
  - yarn run build
  cache:
    paths:
    - lhr/frontend/node_modules/
    - vendor/
  artifacts:
    paths:
    - akl/frontend/dist

publish akl:
  stage: publish
  image: docker
  dependencies:
  - build akl
  - build frontend akl
  script:
  - cd akl
  - docker build
